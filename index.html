<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Huellas Dactilares - ZKTeco ZK4500</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .fingerprint-display {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .fingerprint-display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .fingerprint-placeholder {
            text-align: center;
            color: #6c757d;
        }

        .fingerprint-placeholder svg {
            width: 80px;
            height: 80px;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .user-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
        }

        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #6c757d;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 13px;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí Sistema de Gesti√≥n de Huellas Dactilares</h1>
            <p class="subtitle">ZKTeco ZK4500 - Gesti√≥n Biom√©trica Web</p>
        </header>

        <!-- Estado del Dispositivo -->
        <div class="card">
            <div class="device-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <div>
                    <strong id="deviceStatusText">Dispositivo Desconectado</strong>
                    <p style="font-size: 12px; color: #6c757d; margin-top: 3px;" id="deviceInfo">
                        Conecte el dispositivo ZKTeco ZK4500 por USB
                    </p>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="initializeDevice()">
                    Inicializar Dispositivo
                </button>
                <button class="btn btn-success" onclick="connectDevice()" id="btnConnect" disabled>
                    Conectar
                </button>
                <button class="btn btn-danger" onclick="disconnectDevice()" id="btnDisconnect" disabled>
                    Desconectar
                </button>
                <!-- ‚úÖ BOT√ìN DE DEBUGGING -->
                <button class="btn btn-info" onclick="debugRegistrationStatus()" style="background: #17a2b8;">
                    üêõ Debug Estado
                </button>               
                <button class="btn" onclick="debugLastCapture()" style="background: #6f42c1; color: white;">
                    üî¨ Ver Last Capture
                </button>                 
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('register')">
                    üìù Registrar Huella
                </button>
                <button class="tab" onclick="switchTab('verify')">
                    ‚úÖ Verificar Huella
                </button>
                <button class="tab" onclick="switchTab('users')">
                    üë• Usuarios
                </button>
                <button class="tab" onclick="switchTab('logs')">
                    üìä Logs de Acceso
                </button>
            </div>

            <!-- Tab: Registrar Huella -->
            <div id="tabRegister" class="tab-content active">
                <div class="main-grid">
                    <div>
                        <h2>Informaci√≥n del Usuario</h2>
                        <div class="alert" id="alertRegister"></div>
                        
                        <div class="form-group">
                            <label>ID de Usuario *</label>
                            <input type="text" id="userId" placeholder="Ej: EMP001" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="userName" placeholder="Ej: Juan P√©rez" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Dedo a Registrar</label>
                            <select id="fingerIndex">
                                <option value="1">√çndice Derecho</option>
                                <option value="2">Medio Derecho</option>
                                <option value="3">Anular Derecho</option>
                                <option value="4">Me√±ique Derecho</option>
                                <option value="5">Pulgar Derecho</option>
                                <option value="6">√çndice Izquierdo</option>
                                <option value="7">Medio Izquierdo</option>
                                <option value="8">Anular Izquierdo</option>
                                <option value="9">Me√±ique Izquierdo</option>
                                <option value="10">Pulgar Izquierdo</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="startRegistration()" id="btnStartRegister" disabled>
                            Iniciar Registro
                        </button>
                    </div>

                    <div>
                        <h2>Captura de Huella</h2>
                        <div class="progress-container" id="registerProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p class="progress-text" id="progressText">0 de 3 capturas completadas</p>
                        </div>
                        
                        <div class="fingerprint-display" id="fingerprintDisplay">
                            <div class="fingerprint-placeholder">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94s3.08 1.32 3.08 2.94c0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/>
                                </svg>
                                <p>Esperando captura de huella...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Verificar Huella -->
            <div id="tabVerify" class="tab-content">
                <div class="main-grid">
                    <div>
                        <h2>Verificaci√≥n de Huella</h2>
                        <div class="alert" id="alertVerify"></div>
                        
                        <p style="margin-bottom: 20px; color: #666;">
                            Coloque el dedo en el sensor para verificar la identidad.
                        </p>

                        <button class="btn btn-primary" onclick="startVerification()" id="btnStartVerify" disabled>
                            Iniciar Verificaci√≥n
                        </button>
                        <button class="btn btn-danger" onclick="stopVerification()" id="btnStopVerify" disabled style="display: none;">
                            Detener Verificaci√≥n
                        </button>

                        <div id="verifyResult" style="margin-top: 20px;"></div>
                    </div>

                    <div>
                        <h2>Vista de Huella</h2>
                        <div class="fingerprint-display" id="fingerprintDisplayVerify">
                            <div class="fingerprint-placeholder">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94s3.08 1.32 3.08 2.94c0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.20.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/>
                                </svg>
                                <p>Esperando verificaci√≥n...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Usuarios -->
            <div id="tabUsers" class="tab-content">
                <h2>Lista de Usuarios Registrados</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>Total de Usuarios</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeUsers">0</h3>
                        <p>Usuarios Activos</p>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="loadUsers()">
                    üîÑ Actualizar Lista
                </button>

                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID Usuario</th>
                            <th>Nombre</th>
                            <th>Dedo</th>
                            <th>Fecha Registro</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                No hay usuarios registrados
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Tab: Logs -->
            <div id="tabLogs" class="tab-content">
                <h2>Logs de Acceso</h2>
                <button class="btn btn-primary" onclick="loadLogs()">
                    üîÑ Actualizar Logs
                </button>

                <table class="user-table" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>ID</th>
                            <th>Fecha/Hora</th>
                            <th>Estado</th>
                            <th>M√©todo</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                No hay logs de acceso
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const BRIDGE_URL = 'http://localhost:5000';
        const API_URL = 'api.php';
        
        let isDeviceConnected = false;
        let isRegistering = false;
        let isVerifying = false;
        let isSaving = false; // Nueva bandera para evitar guardados m√∫ltiples
        let captureInterval = null;
        let registerCount = 0;
        let capturedTemplates = [];

        // Funciones de Utilidad
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function updateDeviceStatus(connected, info = '') {
            isDeviceConnected = connected;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('deviceStatusText');
            const deviceInfo = document.getElementById('deviceInfo');
            const btnConnect = document.getElementById('btnConnect');
            const btnDisconnect = document.getElementById('btnDisconnect');
            const btnStartRegister = document.getElementById('btnStartRegister');
            const btnStartVerify = document.getElementById('btnStartVerify');

            if (connected) {
                indicator.classList.add('connected');
                statusText.textContent = 'Dispositivo Conectado';
                deviceInfo.textContent = info || 'Lector ZKTeco ZK4500 listo';
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
                btnStartRegister.disabled = false;
                btnStartVerify.disabled = false;
            } else {
                indicator.classList.remove('connected');
                statusText.textContent = 'Dispositivo Desconectado';
                deviceInfo.textContent = info || 'Conecte el dispositivo ZKTeco ZK4500 por USB';
                btnConnect.disabled = false;
                btnDisconnect.disabled = true;
                btnStartRegister.disabled = true;
                btnStartVerify.disabled = true;
            }
        }

        // Funciones del Dispositivo
        async function initializeDevice() {
            try {
                const response = await fetch(`${BRIDGE_URL}/api/device/initialize`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('alertRegister', `Dispositivo inicializado: ${data.device_count} dispositivo(s) encontrado(s)`, 'success');
                    document.getElementById('btnConnect').disabled = false;
                } else {
                    showAlert('alertRegister', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('alertRegister', 'Error al conectar con el servicio bridge. Aseg√∫rese de que est√© ejecut√°ndose.', 'error');
            }
        }

        async function connectDevice() {
            try {
                const response = await fetch(`${BRIDGE_URL}/api/device/open`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index: 0})
                });
                const data = await response.json();
                
                if (data.success) {
                    updateDeviceStatus(true, `Conectado - Resoluci√≥n: ${data.width}x${data.height}`);
                    showAlert('alertRegister', 'Dispositivo conectado exitosamente', 'success');
                } else {
                    showAlert('alertRegister', `Error al conectar: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('alertRegister', 'Error de conexi√≥n con el servicio', 'error');
            }
        }

        async function disconnectDevice() {
            try {
                stopCapture();
                const response = await fetch(`${BRIDGE_URL}/api/device/close`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    updateDeviceStatus(false);
                    showAlert('alertRegister', 'Dispositivo desconectado', 'info');
                }
            } catch (error) {
                showAlert('alertRegister', 'Error al desconectar', 'error');
            }
        }

        async function debugRegistrationStatus() {
            try {
                console.log('üêõ Solicitando estado de registro...');
                const response = await fetch(`${BRIDGE_URL}/api/debug/registration_status`);
                const data = await response.json();
                
                console.log('üìä ESTADO DE REGISTRO:', data);
                
                if (data.success) {
                    alert(`üêõ Estado de Registro:\n` +
                        `Modo: ${data.status.current_mode}\n` +
                        `Capturas: ${data.status.register_count}/3\n` +
                        `Plantillas almacenadas: ${data.status.templates_stored}\n` +
                        `Dispositivo conectado: ${data.status.device_connected}\n` +
                        `Capturando: ${data.status.is_capturing}\n` +
                        `Tiene plantilla final: ${data.status.last_capture_has_final}\n` +
                        `Registro completo: ${data.status.last_capture_complete}`);
                }
            } catch (error) {
                console.error('‚ùå Error en debug:', error);
                alert('Error al obtener estado de registro');
            }
        }        

        async function debugLastCapture() {
            try {
                console.log('üî¨ Solicitando last_capture...');
                const response = await fetch(`${BRIDGE_URL}/api/debug/last_capture`);
                const data = await response.json();
                
                console.log('üìä LAST CAPTURE:', data);
                
                if (data.success) {
                    alert(`üî¨ Last Capture:\n` +
                        `Modo: ${data.current_mode}\n` +
                        `Capturas: ${data.register_count}\n` +
                        `Capturando: ${data.is_capturing}\n` +
                        `\nDatos en last_capture:\n` +
                        JSON.stringify(data.last_capture, null, 2));
                } else {
                    alert(`No hay datos: ${data.message}`);
                }
            } catch (error) {
                console.error('‚ùå Error en debug:', error);
                alert('Error al obtener last_capture');
            }
        }

        async function startRegistration() {
            const userId = document.getElementById('userId').value.trim();
            const userName = document.getElementById('userName').value.trim();
            
            if (!userId || !userName) {
                showAlert('alertRegister', 'Complete todos los campos requeridos', 'error');
                return;
            }

            // ‚úÖ VERIFICAR QUE EL DISPOSITIVO EST√â CONECTADO
            if (!isDeviceConnected) {
                showAlert('alertRegister', 'El dispositivo no est√° conectado', 'error');
                return;
            }

            // ‚úÖ DETENER CUALQUIER PROCESO PREVIO
            stopCapture();
            
            // ‚úÖ RESETEAR VARIABLES
            isRegistering = true;
            registerCount = 0;
            capturedTemplates = [];
            
            // ‚úÖ MOSTRAR PROGRESO
            document.getElementById('registerProgress').style.display = 'block';
            updateProgress(0);
            
            showAlert('alertRegister', 'Coloque el mismo dedo 3 veces en el sensor', 'info');
            
            try {
                // ‚úÖ ESTABLECER MODO DE REGISTRO EN EL BRIDGE
                console.log('üîÑ Configurando modo registering...');
                const modeResponse = await fetch(`${BRIDGE_URL}/api/mode/set`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mode: 'registering'})
                });
                
                const modeResult = await modeResponse.json();
                console.log('üìã Respuesta modo:', modeResult);
                
                if (!modeResult.success) {
                    throw new Error(`Error al configurar modo: ${modeResult.message}`);
                }
                
                // ‚úÖ INICIAR CAPTURA DESPU√âS DE UN BREVE DELAY
                setTimeout(() => {
                    console.log('üé• Iniciando captura...');
                    startCapture();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error al iniciar registro:', error);
                showAlert('alertRegister', `Error al configurar el dispositivo: ${error.message}`, 'error');
                stopCapture();
            }
        }

        function updateProgress(count) {
            registerCount = count;
            const percentage = (count / 3) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${count} de 3 capturas completadas`;
        }

        function startCapture() {
            if (captureInterval) return;

            console.log('üé• Iniciando captura continua...');
            
            captureInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BRIDGE_URL}/api/capture/get`);
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // ‚úÖ LOGGING MEJORADO
                        if (isRegistering) {
                            console.log('üì∏ Captura recibida:', {
                                count: data.data.register_count,
                                complete: data.data.registration_complete,
                                hasFinal: !!data.data.final_template,
                                inProgress: data.data.registration_in_progress
                            });
                        }

                        processCapture(data.data);
                    } else if (!data.success && data.message) {
                        // ‚úÖ MANEJAR ERRORES DEL BACKEND
                        console.warn('‚ö†Ô∏è Backend report√≥:', data.message);
                    }
                } catch (error) {
                    console.error('Error en captura:', error);
                }
            }, 800); // ‚úÖ AUMENTAR intervalo a 800ms para evitar saturaci√≥n
        }

        function stopCapture() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            isRegistering = false;
            isVerifying = false;
        }

        async function processCapture(captureData) {
            console.log('üîç processCapture llamado con:', {
                hasImage: !!captureData.image,
                registerCount: captureData.register_count,
                registrationComplete: captureData.registration_complete,
                hasFinalTemplate: !!captureData.final_template,
                registrationInProgress: captureData.registration_in_progress,
                registrationError: captureData.registration_error
            });
            
            // Mostrar imagen de huella
            const displayId = isRegistering ? 'fingerprintDisplay' : 'fingerprintDisplayVerify';
            const display = document.getElementById(displayId);
            
            if (captureData.image) {
                display.innerHTML = `<img src="data:image/png;base64,${captureData.image}" alt="Huella">`;
            }
            
            // ‚úÖ CORRECCI√ìN: DETECCI√ìN MEJORADA DE ESTADOS DE REGISTRO
            if (isRegistering) {
                await processRegistrationCapture(captureData);
            } else if (isVerifying) {
                await processVerificationCapture(captureData);
            }
        }

    async function processRegistrationCapture(captureData) {
            console.log('üìù Procesando captura de registro:', {
                registerCount: captureData.register_count,
                complete: captureData.registration_complete,
                hasFinal: !!captureData.final_template,
                error: captureData.registration_error,
                timestamp: captureData.completion_timestamp
            });
            
            // ‚úÖ PRIORIDAD 1: DETECTAR ERROR DE REGISTRO PRIMERO
            if (captureData.registration_error) {
                console.error('‚ùå Error en registro:', captureData.registration_error);
                showAlert('alertRegister', `Error: ${captureData.registration_error}`, 'error');
                
                // NO detenga la captura, solo muestre el error y espere
                // a que el usuario levante el dedo.
                return; 
            }
            
            // ‚úÖ PRIORIDAD 2: ACTUALIZAR PROGRESO SI HAY CONTADOR
            if (captureData.register_count !== undefined && captureData.register_count !== null) {
                updateProgress(captureData.register_count);
                
                if (captureData.register_count < 3) {
                    showAlert('alertRegister', `Captura ${captureData.register_count} completada. Coloque el dedo nuevamente.`, 'success');
                } else if (captureData.register_count >= 3) {
                    showAlert('alertRegister', '‚úÖ 3 capturas completadas. Procesando...', 'success');
                }
            }
            
            // ‚úÖ PRIORIDAD 3: DETECCI√ìN CR√çTICA DE COMPLETITUD
            // Verificar AMBAS condiciones: registration_complete === true Y final_template existe
            if (captureData.registration_complete && captureData.final_template) {
                console.log('üéØ REGISTRO COMPLETADO - Plantilla final recibida:', {
                    templateLength: captureData.final_template.length,
                    timestamp: captureData.completion_timestamp
                });
                
                // DETENER CAPTURA INMEDIATAMENTE
                stopCapture();
                isRegistering = false;
                
                // ‚úÖ MOSTRAR CONFIRMACI√ìN
                showAlert('alertRegister', '‚úÖ 3 capturas completadas. Guardando huella...', 'success');

                // ‚úÖ GUARDAR CON PEQUE√ëO DELAY PARA ASEGURAR QUE EL ESTADO SE ACTUALIZ√ì
                setTimeout(async () => {
                    await saveFingerprint(captureData.final_template);
                }, 500);                

                return; // Salir de la funci√≥n

            }
            // ‚úÖ DETECCI√ìN DE ESTADOS INTERMEDIOS
            if (captureData.register_count >= 3 && !captureData.registration_complete) {
                console.log('‚è≥ Esperando generaci√≥n de plantilla final...');
                // No hacer nada, seguir esperando
            }
            
            // ‚úÖ ALERTA SI HAY INCONSISTENCIA
            if (captureData.registration_complete === true && !captureData.final_template) {
                console.error('‚ùå INCONSISTENCIA: Registro marcado completo pero sin plantilla');
                showAlert('alertRegister', '‚ùå Error: Registro completo pero sin plantilla. Reintente.', 'error');
                stopCapture();
                isRegistering = false;
            }            
        }

        async function saveFingerprint(template) {
            const userId = document.getElementById('userId').value.trim();
            const userName = document.getElementById('userName').value.trim();
            const fingerIndex = document.getElementById('fingerIndex').value;
            
            if (!userId || !userName) {
                showAlert('alertRegister', 'Complete todos los campos requeridos', 'error');
                return;
            }
            
            if (!template) {
                showAlert('alertRegister', 'No se pudo obtener la plantilla de huella', 'error');
                return;
            }
            
            // Mostrar indicador de guardando
            showAlert('alertRegister', '‚è≥ Guardando huella en la base de datos...', 'info');
            
            try {
                console.log('üîß Guardando huella:', { 
                    user_id: userId, 
                    name: userName, 
                    finger_index: fingerIndex,
                    template_length: template.length 
                });
                
                const response = await fetch(`${API_URL}?action=register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        name: userName,
                        template: template,
                        finger_index: parseInt(fingerIndex)
                    })
                });
                
                // ‚úÖ CORRECCI√ìN: Mejor manejo de respuesta
                const responseText = await response.text();
                console.log('üì® Respuesta cruda del servidor:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('‚ùå Error parseando JSON:', e);
                    throw new Error(`Respuesta inv√°lida del servidor: ${responseText.substring(0, 100)}`);
                }
                
                console.log('üìä Respuesta del servidor parseada:', data);
                
                if (data.success) {
                    showAlert('alertRegister', `‚úÖ Huella registrada exitosamente: ${data.name} (ID: ${data.user_id})`, 'success');
                    
                    // ‚úÖ CORRECCI√ìN: LIMPIAR FORMULARIO PRIMERO
                    document.getElementById('userId').value = '';
                    document.getElementById('userName').value = '';
                    document.getElementById('registerProgress').style.display = 'none';
                    
                    // Resetear display de huella
                    document.getElementById('fingerprintDisplay').innerHTML = `
                        <div class="fingerprint-placeholder">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94s3.08 1.32 3.08 2.94c0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/>
                            </svg>
                            <p>Esperando captura de huella...</p>
                        </div>
                    `;
                    
                    // ‚úÖ CORRECCI√ìN: Resetear variables de estado
                    registerCount = 0;
                    capturedTemplates = [];
                    isRegistering = false;
                    
                    // ‚úÖ CORRECCI√ìN: Resetear el dispositivo despu√©s de guardar exitosamente
                    try {
                        await fetch(`${BRIDGE_URL}/api/registration/reset`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });
                        console.log('‚úÖ Estado de registro reseteado en el dispositivo');
                    } catch (resetError) {
                        console.warn('‚ö†Ô∏è No se pudo resetear el dispositivo:', resetError);
                    }
                    
                    // Cambiar modo a idle en el bridge
                    await fetch(`${BRIDGE_URL}/api/mode/set`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({mode: 'idle'})
                    });
                    
                    // Recargar lista de usuarios
                    loadUsers();
                    
                } else {
                    showAlert('alertRegister', `‚ùå Error: ${data.message}`, 'error');
                    
                    // ‚úÖ CORRECCI√ìN: Resetear tambi√©n en caso de error
                    try {
                        await fetch(`${BRIDGE_URL}/api/registration/reset`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });
                    } catch (resetError) {
                        console.warn('‚ö†Ô∏è No se pudo resetear el dispositivo despu√©s del error:', resetError);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error al guardar:', error);
                showAlert('alertRegister', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                
                // ‚úÖ CORRECCI√ìN: Resetear tambi√©n en caso de error de conexi√≥n
                try {
                    await fetch(`${BRIDGE_URL}/api/registration/reset`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                } catch (resetError) {
                    console.warn('‚ö†Ô∏è No se pudo resetear el dispositivo despu√©s del error de conexi√≥n:', resetError);
                }
            }
        }

// ‚úÖ *** NUEVA FUNCI√ìN A√ëADIDA ***
        // Esta funci√≥n faltaba y romp√≠a la verificaci√≥n.
        async function processVerificationCapture(captureData) {
            // Comprobar si el bridge tiene una plantilla lista para verificar
            if (captureData.ready_for_verification && captureData.template) {
                console.log('‚úÖ Huella lista para verificaci√≥n. Deteniendo captura.');
                
                // Detener el sondeo inmediatamente
                stopCapture(); 
                
                // Mostrar "procesando"
                showAlert('alertVerify', 'üîç Huella capturada. Verificando...', 'info');
                
                // Llamar a la l√≥gica de verificaci√≥n principal
                await verifyFingerprint(captureData.template);
            }
        }

        let verificationTimeout = null;

        // Funciones de Verificaci√≥n
        async function startVerification() {
            isVerifying = true;
            document.getElementById('btnStartVerify').style.display = 'none';
            document.getElementById('btnStopVerify').style.display = 'inline-block';
            
            showAlert('alertVerify', 'üëÜ Coloque el dedo en el sensor para verificar', 'info');
            
            await fetch(`${BRIDGE_URL}/api/mode/set`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({mode: 'verifying'})
            });
            
            startCapture();

            // ‚úÖ AGREGAR: Timeout de 30 segundos
            verificationTimeout = setTimeout(() => {
                if (isVerifying) {
                    showAlert('alertVerify', '‚è±Ô∏è Tiempo de verificaci√≥n agotado', 'info');
                    stopVerification();
                }
            }, 30000);
            
        }

        function stopVerification() {
            // ‚úÖ AGREGAR: Limpiar timeout
            if (verificationTimeout) {
                clearTimeout(verificationTimeout);
                verificationTimeout = null;
            }
            
            stopCapture();
            document.getElementById('btnStartVerify').style.display = 'inline-block';
            document.getElementById('btnStopVerify').style.display = 'none';
            document.getElementById('verifyResult').innerHTML = '';
        }

// index.html - Reemplazar la funci√≥n completa async function verifyFingerprint(template)

        async function verifyFingerprint(template) {
            try {
                // CORRECCI√ìN DE SEGURIDAD:
                // Ya NO se obtienen todas las plantillas en el cliente.
                // Se llama al nuevo endpoint del Bridge, que hace la verificaci√≥n 1:N.
                const matchResponse = await fetch(`${BRIDGE_URL}/api/db/match_one_to_many`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        captured_template: template // Solo enviamos la plantilla capturada
                    })
                });

                const matchData = await matchResponse.json();

                // Verificar si la llamada al bridge fall√≥
                if (!matchData.success) {
                    showAlert('alertVerify', `Error del servicio Bridge: ${matchData.message}`, 'error');
                    stopVerification(); // Detener el proceso
                    return;
                }

                // Si hay coincidencia (matchData.match es true)
                if (matchData.match) {
                    const matchedUser = matchData.matched_user;

                    document.getElementById('verifyResult').innerHTML = `
                        <div class="alert alert-success show">
                            <h3>‚úÖ Acceso Permitido (Score: ${matchedUser.score}%)</h3>
                            <p>Bienvenido: <strong>${matchedUser.name}</strong> (ID: ${matchedUser.user_id})</p>
                            <p>Huella: Dedo ${matchedUser.finger_index}</p>
                        </div>
                    `;
                    showAlert('alertVerify', '‚úÖ Verificaci√≥n Exitosa', 'success');
                    
                    // Registrar acceso exitoso (usando el id interno devuelto por el bridge)
                    await fetch(`${API_URL}?action=log_access`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            user_id: matchedUser.id, // ID interno (INT)
                            status: 'success', 
                            method: 'fingerprint' 
                        })
                    });

                    // Detener verificaci√≥n despu√©s de 3 segundos
                    setTimeout(() => {
                        stopVerification();
                    }, 3000);
                    
                } else {
                    // No hay coincidencia (matchData.match es false)
                    document.getElementById('verifyResult').innerHTML = `
                        <div class="alert alert-error show">
                            <h3>‚ùå Acceso Denegado</h3>
                            <p>${matchData.message || 'Huella no reconocida'}</p>
                            <p>(Mejor Score: ${matchData.best_score || 0}%)</p>
                        </div>
                    `;
                    showAlert('alertVerify', '‚ùå Huella no reconocida', 'error');

                    // Registrar intento fallido
                    await fetch(`${API_URL}?action=log_access`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            user_id: null, 
                            status: 'failed', 
                            method: 'fingerprint' 
                        })
                    });
                    
                    // Permitir un nuevo intento reiniciando la verificaci√≥n
                    // (el usuario puede volver a poner el dedo)
                    setTimeout(() => {
                        startVerification();
                    }, 1500);
                }

            } catch (error) {
                console.error('Error en verificaci√≥n:', error);
                showAlert('alertVerify', `Error al verificar: ${error.message}`, 'error');
                stopVerification();
            } finally {
                // isVerifying se mantiene true si queremos reintentar, 
                // o se pone false en stopVerification()
                isVerifying = false;
            }
        }

        // Funciones de Usuarios
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}?action=users`);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('userTableBody');
                    
                    if (data.users.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                    No hay usuarios registrados
                                </td>
                            </tr>
                        `;
                        document.getElementById('totalUsers').textContent = '0';
                        document.getElementById('activeUsers').textContent = '0';
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    let activeCount = 0;
                    
                    data.users.forEach(user => {
                        if (user.status == 1) activeCount++;
                        
                        const fingerNames = {
                            1: '√çndice Der.', 2: 'Medio Der.', 3: 'Anular Der.',
                            4: 'Me√±ique Der.', 5: 'Pulgar Der.', 6: '√çndice Izq.',
                            7: 'Medio Izq.', 8: 'Anular Izq.', 9: 'Me√±ique Izq.',
                            10: 'Pulgar Izq.'
                        };
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.user_id}</td>
                            <td>${user.name}</td>
                            <td>${fingerNames[user.finger_index] || 'N/A'}</td>
                            <td>${new Date(user.created_at).toLocaleString('es-ES')}</td>
                            <td>
                                <span class="badge ${user.status == 1 ? 'badge-active' : 'badge-inactive'}">
                                    ${user.status == 1 ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.name}')">
                                    üóëÔ∏è Eliminar
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('totalUsers').textContent = data.users.length;
                    document.getElementById('activeUsers').textContent = activeCount;
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`¬øEst√° seguro de eliminar al usuario "${userName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=delete&id=${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('alertRegister', 'Usuario eliminado exitosamente', 'success');
                    loadUsers();
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                alert('Error al eliminar usuario');
            }
        }

        // Funciones de Logs
        async function loadLogs() {
            try {
                const response = await fetch(`${API_URL}?action=logs&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('logsTableBody');
                    
                    if (data.logs.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                    No hay logs de acceso
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        const statusBadge = log.status === 'success' 
                            ? '<span class="badge badge-active">‚úÖ Autorizado</span>'
                            : '<span class="badge badge-inactive">‚ùå Denegado</span>';
                        
                        row.innerHTML = `
                            <td>${log.name || 'Desconocido'}</td>
                            <td>${log.user_id || 'N/A'}</td>
                            <td>${new Date(log.access_time).toLocaleString('es-ES')}</td>
                            <td>${statusBadge}</td>
                            <td>${log.method}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error al cargar logs:', error);
            }
        }

        // Funci√≥n para cambiar tabs
        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones de tab
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el tab seleccionado
            const tabMap = {
                register: 'tabRegister',
                verify: 'tabVerify',
                users: 'tabUsers',
                logs: 'tabLogs'
            };
            
            document.getElementById(tabMap[tabName]).classList.add('active');
            event.target.classList.add('active');
            
            // Cargar datos seg√∫n el tab
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        // Verificar estado del servicio bridge al cargar
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${BRIDGE_URL}/api/health`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert('alertRegister', '‚úÖ Servicio Bridge conectado', 'success');
                }
            } catch (error) {
                showAlert('alertRegister', '‚ö†Ô∏è Servicio Bridge no disponible. Inicie el servicio Python.', 'error');
            }
            
            // Cargar usuarios al inicio
            loadUsers();
        });

        // Limpiar intervalos al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            stopCapture();
        });
    </script>
</body>
</html>